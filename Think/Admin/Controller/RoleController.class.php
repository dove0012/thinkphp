<?phpnamespace Admin\Controller;use Common\Controller\CommonController;class RoleController extends CommonController {        public function _initialize() {        $this->model = D('Role');    }        public function take() {        $res = $this->model->select();        exit(json_encode($res));    }        public function add_role() {        if ($_POST) {            if (!$this->model->create()) {                $this->error($this->model->getError());            }            $this->model->add() ? $this->success('添加成功!') : $this->error('添加失败!');        } else {            $this->display();        }    }        public function del_role($id) {        $this->model->where('id=' . $id)->delete() ? $this->success('删除成功!') : $this->error('删除失败!');    }        public function edit_role($id = 0) {        if ($_POST) {            $_POST['id'] = session(__URL__ . '_edit_id');            if (!$this->model->create()) {                $this->error($this->model->getError());            }            $res = $this->model->save();            session(__URL__ . '_edit_id', null);            $res ? $this->success('编辑成功!') : $this->error('编辑失败!');        } else {            session(__URL__ . '_edit_id', $id); //记录要编辑的ID            $this->assign('res', $this->model->where('id=' . $id)->find());            $this->display('add_role');        }    }        public function edit_power($id=0) {        if ($_POST) {            $this->model = M('access');            $roleId = session(__URL__ . '_edit_id');            if(!$this->model->where(array('role_id'=>$roleId,'node_id'=>$_POST['appid'],'pid'=>0))->find()){                $data['role_id'] = $roleId;                $data['node_id'] = $_POST['appid'];                $data['level'] = 1;                $data['pid'] = 0;                if ($this->model->add($data) === FALSE) $this->error('添加项目权限失败!');            }            foreach($_POST['module'] as $k => $v){                if($v){                    if (!$this->model->where(array('role_id' => $roleId, 'node_id' => $_POST['module_id'][$k], 'pid' => $_POST['appid']))->find()) {                        $data = array();                        $data['role_id'] = $roleId;                        $data['node_id'] = $_POST['module_id'][$k];                        $data['level'] = 2;                        $data['pid'] = $_POST['appid'];                        if ($this->model->add($data) === FALSE) $this->error('添加' . $k . '模块权限失败!');                    }                }else{                    $res = $this->model->where(array('role_id'=>$roleId,'node_id'=>$_POST['module_id'][$k],'pid'=>$_POST['appid']))->delete();                    if($res === FALSE) $this->error ('删除' . $k . '模块权限失败!');                }                foreach ($_POST[$k.'_action'] as $x => $y) {                    if($y){                        if(!$this->model->where(array('role_id'=>$roleId,'node_id'=>$_POST['action_id'][$k.'_'.$x],'pid'=>$_POST['module_id'][$k]))->find()){                            $data = array();                            $data['role_id'] = $roleId;                            $data['node_id'] = $_POST['action_id'][$k.'_'.$x];                            $data['level'] = 3;                            $data['pid'] = $_POST['module_id'][$k];                            if($this->model->add($data) === FALSE) $this->error('添加' . $x . '操作权限失败!');                        }                    }else{                        $res = $this->model->where(array('role_id'=>$roleId,'node_id'=>$_POST['action_id'][$k.'_'.$x],'pid'=>$_POST['module_id'][$k]))->delete();                        if($res === FALSE) $this->error ('删除' . $x . '操作权限失败!');                    }                }            }            $this->success('编辑角色权限成功!');        } else {            session(__URL__ . '_edit_id', $id); //记录要编辑的ID            $res = $this->model->table(C('DB_PREFIX') . 'node')->where('pid=0 and status=1')->select();            $this->assign('apps', $res);            $this->assign('roleId', $id);            $this->display();        }    }        public function get_node($id, $roleId) {        //获取此角色原有访问权限        $power = $this->model->table(C('DB_PREFIX') . 'access')->where('role_id=' . $roleId)->select();        $module = $this->model->table(C('DB_PREFIX') . 'node')->where('status=1 and pid=' . $id)->order('sort')->select();        $node = array();        if ($module) {            foreach ($module as $k => $v) {                $node[$k]['module'] = $v;                $node[$k]['module']['checked'] = 0;                foreach ($power as $x => $y) {                    if ($v['id'] == $y['node_id']) {                        $node[$k]['module']['checked'] = 1;                        unset($power[$x]);                    }                }                $node[$k]['action'] = $this->model->table(C('DB_PREFIX') . 'node')->where('status=1 and pid=' . $v['id'])->select();                foreach ($node[$k]['action'] as $q => $w) {                    $node[$k]['action'][$q]['checked'] = 0;                    foreach ($power as $r) {                        if ($w['id'] == $r['node_id']) {                            $node[$k]['action'][$q]['checked'] = 1;                        }                    }                }            }        }        exit(json_encode($node));    }        public function edit_value() {        $value = $_POST['value'] == 1 ? 1 : 0;        $data[$_POST['type']] = $value;        $this->model->where('id=' . $_POST['id'])->save($data) ? $this->success() : $this->error();    }}