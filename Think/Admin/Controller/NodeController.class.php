<?phpnamespace Admin\Controller;use Common\Controller\CommonController;class NodeController extends CommonController {    public function _initialize() {        $this->model = D('Node');    }        public function take() {        exit(json_encode($this->model->where('pid=0')->select()));    }        public function edit_power($id = 0) {        if ($_POST) {            $id = session(__URL__ . '_edit_id');            foreach ($_POST['module'] as $k => $v) {                $data['name'] = $k;                $data['title'] = $_POST['module_title'][$k];                $data['status'] = $v ? 1 : 0;                $data['sort'] = $_POST['module_sort'][$k];                $data['pid'] = $id;                $data['level'] = 2;                if ($_POST['module_id'][$k]) {                    $res = $this->model->where('id='.$_POST['module_id'][$k])->save($data);                    $moduleId = $_POST['module_id'][$k];                } else {                    $res = $this->model->add($data);                    $moduleId = $res;                }                if ($res === FALSE) $this->error('添加/编辑' . $k . '[' . $data['title'] . ']模块失败!');                foreach ($_POST[$k . '_Controller'] as $x => $y) {                    $data['name'] = $x;                    $data['title'] = $_POST['Controller_title'][$k . '_' . $x];                    $data['status'] = $y ? 1 : 0;                    $data['sort'] = $_POST['Controller_sort'][$k . '_' . $x];                    $data['pid'] = $moduleId;                    $data['level'] = 3;                    if ($_POST['Controller_id'][$k . '_' . $x]) {                        $res = $this->model->where('id='.$_POST['Controller_id'][$k . '_' . $x])->save($data);                    } else {                        $res = $this->model->add($data);                    }                    if ($res === FALSE) $this->error('添加/编辑' . $k . '[' . $data['title'] . ']操作失败!');                }            }            $this->success('所有节点添加成功!');        } else {            session(__URL__ . '_edit_id', $id); //记录要编辑的ID            //获取项目原有权限节点            $existingModule = $this->model->where('pid=' . $id)->select();            if ($existingModule) {                foreach ($existingModule as $k => $v) {                    $existingNode[$k]['module'] = $v;                    $existingNode[$k]['Controller'] = $this->model->where('pid=' . $v['id'])->select();                }            }            //获取全部最新的权限节点并和原有做对比            $objects = new \RecursiveIteratorIterator(new \RecursiveDirectoryIterator(APP_PATH.'/Admin/Controller/'));            $unGetModule = array('Public', 'Login');            $unGetAction = array('_initialize');            $i = 0;            foreach ($objects as $v) {                $fileName = $v->getFilename();                if($fileName == '.' or $fileName == '..') continue;                $modelName = str_replace('Controller.class.php', '', $fileName);                if (!in_array($modelName, $unGetModule)) {                    $fullPath = $v->getPath() . '/' . $fileName;                    $html = file_get_contents($fullPath);                    $res = preg_match_all("/public\s+function\s+(\S+)\(/", $html, $matches);                    $node[$i]['moduleName'] = $modelName;                    foreach ($existingNode as $q) {                        if ($q['module']['name'] == $modelName) {                            $node[$i]['id'] = $q['module']['id'];                            $node[$i]['title'] = $q['module']['title'];                            $node[$i]['sort'] = $q['module']['sort'];                            $node[$i]['checked'] = $q['module']['status'] ? 1 : 0;                            $existingAction = $q['Controller'];                        }                    }                    if (is_array($matches[1])) {                        foreach ($matches[1] as $k => $x) {                            if (!in_array($x, $unGetAction) && ($x != ($modelName . 'Controller'))) {                                $node[$i]['ControllerName'][$k]['name'] = $x;                                foreach ($existingAction as $w) {                                    if ($w['name'] == $x) {                                        $node[$i]['ControllerName'][$k]['id'] = $w['id'];                                        $node[$i]['ControllerName'][$k]['title'] = $w['title'];                                        $node[$i]['ControllerName'][$k]['sort'] = $w['sort'];                                        $node[$i]['ControllerName'][$k]['checked'] = $w['status'] ? 1 : 0;                                    }                                }                            }                        }                    }                    unset($existingAction);                    $i++;                }            }            $this->assign('node', $node);            $this->display();        }    }        public function edit_value() {        $value = $_POST['value'] == 1 ? 1 : 0;        $data[$_POST['type']] = $value;        $this->model->where('id=' . $_POST['id'])->save($data) ? $this->success() : $this->error();    }        public function add_app() {        if ($_POST) {            $_POST['pid'] = 0;            $_POST['level'] = 1;            if (!$this->model->create()) {                $this->error($this->model->getError());            }            $this->model->add() ? $this->success('添加成功!') : $this->error('添加失败!');        } else {            $this->display('add_app');        }    }        public function del_app($id) {        $this->model->where('id=' . $id)->delete() ? $this->success('删除成功!') : $this->error('删除失败!');    }        public function edit_app($id = 0) {        if ($_POST) {            $_POST['id'] = session(__URL__ . '_edit_id');            if (!$this->model->create()) {                $this->error($this->model->getError());            }            $res = $this->model->save();            session(__URL__ . '_edit_id', null);            $res ? $this->success('编辑成功!') : $this->error('编辑失败!');        } else {            session(__URL__ . '_edit_id', $id); //记录要编辑的ID            $this->assign('res', $this->model->where('id=' . $id)->find());            $this->display('add_app');        }    }}